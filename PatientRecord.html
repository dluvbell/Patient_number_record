<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™˜ì í†µê³„ ê´€ë¦¬ì</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --input-bg: #ffffff;
            --table-head-bg: #f8fafc;
        }

        /* ë‹¤í¬ëª¨ë“œ ë³€ìˆ˜ ì •ì˜ */
        body.dark-mode {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f3f4f6;
            --border-color: #374151;
            --input-bg: #374151;
            --table-head-bg: #374151;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            font-size: 16px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        /* ë‹¤í¬ëª¨ë“œ í† ê¸€ ë²„íŠ¼ */
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
        }

        h2 {
            margin-bottom: 15px;
            font-size: 1.25rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        h3 {
            margin-top: 30px;
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: var(--text-color);
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .col {
            flex: 1;
            min-width: 120px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .radio-group {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .radio-label {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            background: var(--input-bg);
            transition: all 0.2s;
        }

        input[type="radio"] {
            display: none;
        }

        input[type="radio"]:checked + .radio-label {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: bold;
        }

        button.btn-primary {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        button.btn-primary:active {
            transform: scale(0.98);
        }

        /* í†µê³„ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .stats-control {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        th, td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--table-head-bg);
            font-weight: 600;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* ìš”ì¼ë³„ ìƒ‰ìƒ */
        .day-sat { color: #3b82f6; }
        .day-sun { color: #ef4444; }

        /* ë°°ê²½ìƒ‰ í´ë˜ìŠ¤ (íŒŒìŠ¤í…”í†¤) */
        .bg-lunch {
            background-color: #fef9c3 !important;
            color: #1f2937 !important;
        }
        
        .bg-dinner {
            background-color: #bfdbfe !important;
            color: #1f2937 !important;
        }
        
        /* ë‹¤í¬ëª¨ë“œì—ì„œ ìë™ê³„ì‚° ìš”ì¼ ë°•ìŠ¤ */
        #displayDayOfWeek {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color);
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .card { padding: 15px; }
            th, td { padding: 8px 4px; font-size: 0.85rem; }
            .theme-toggle { top: -40px; right: 0; }
            .container { margin-top: 40px; }
        }
    </style>
</head>
<body>

<div class="container">
    <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ Dark Mode</button>

    <div class="card">
        <h2>ğŸ“ í™˜ì ê¸°ë¡ ì…ë ¥</h2>
        <div class="form-group row">
            <div class="col">
                <label>ì—°ë„ (Year)</label>
                <select id="inputYear"></select>
            </div>
            <div class="col">
                <label>ì›” (Month)</label>
                <select id="inputMonth"></select>
            </div>
            <div class="col">
                <label>ì¼ (Day)</label>
                <select id="inputDay"></select>
            </div>
        </div>
        
        <div class="form-group">
            <label>ìš”ì¼ (ìë™ ê³„ì‚°)</label>
            <div id="displayDayOfWeek" style="padding: 10px; background: #f1f5f9; border-radius: 8px; font-weight: bold; color: #475569;">
                ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”
            </div>
        </div>

        <div class="form-group row">
            <div class="col">
                <label>ì‹œê°„ëŒ€ (Shift)</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="shift" value="lunch" checked>
                        <span class="radio-label">â˜€ï¸ ì ì‹¬ë°˜</span>
                    </label>
                    <label>
                        <input type="radio" name="shift" value="dinner">
                        <span class="radio-label">ğŸŒ™ ì €ë…ë°˜</span>
                    </label>
                </div>
            </div>
            <div class="col">
                <label>í™˜ì ìˆ˜ (ëª…)</label>
                <input type="number" id="patientCount" placeholder="0" min="0">
            </div>
        </div>

        <button class="btn-primary" onclick="addRecord()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
    </div>

    <div class="card">
        <h2>ğŸ“Š í†µê³„ ë¶„ì„ (Statistics)</h2>
        
        <h3>ğŸ“… ì›”ë³„ í†µê³„ (Monthly)</h3>
        <div class="stats-control">
            <select id="statsYear" style="width: auto;" onchange="renderStats()"></select>
            <select id="statsMonth" style="width: auto;" onchange="renderStats()"></select>
        </div>
        <div class="table-wrapper">
            <table id="statsTable">
                <thead>
                    <tr>
                        <th rowspan="2">ìš”ì¼</th>
                        <th colspan="2" class="bg-lunch">ì ì‹¬ë°˜ (Lunch)</th>
                        <th colspan="2" class="bg-dinner">ì €ë…ë°˜ (Dinner)</th>
                    </tr>
                    <tr>
                        <th class="bg-lunch">ì´í•©</th>
                        <th class="bg-lunch">í‰ê· </th>
                        <th class="bg-dinner">ì´í•©</th>
                        <th class="bg-dinner">í‰ê· </th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <h3>ğŸ“… ì—°ê°„ í†µê³„ (Yearly)</h3>
        <div class="table-wrapper">
            <table id="yearlyStatsTable">
                <thead>
                    <tr>
                        <th rowspan="2">ìš”ì¼ (Day)</th>
                        <th colspan="2" class="bg-lunch">ì ì‹¬ë°˜ (Lunch)</th>
                        <th colspan="2" class="bg-dinner">ì €ë…ë°˜ (Dinner)</th>
                    </tr>
                    <tr>
                        <th class="bg-lunch">ì´í•©</th>
                        <th class="bg-lunch">í‰ê· </th>
                        <th class="bg-dinner">ì´í•©</th>
                        <th class="bg-dinner">í‰ê· </th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ ìµœê·¼ ê¸°ë¡ ë‚´ì—­</h2>
        <div class="table-wrapper">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ìš”ì¼</th>
                        <th>ì‹œê°„ëŒ€</th>
                        <th>ì¸ì›</th>
                        <th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
    const STORAGE_KEY = 'patient_records_v1';
    let records = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    // ì´ˆê¸°í™” ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        initDateSelectors();
        loadTheme();
        renderStats(); // ì›”ë³„, ì—°ë³„ í†µê³„ ëª¨ë‘ ë Œë”ë§
        renderHistory();
    });

    // ë‹¤í¬ëª¨ë“œ ê´€ë¦¬
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.querySelector('.theme-toggle').textContent = isDark ? 'â˜€ï¸ Light Mode' : 'ğŸŒ™ Dark Mode';
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            document.querySelector('.theme-toggle').textContent = 'â˜€ï¸ Light Mode';
        }
    }

    // 1. ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function initDateSelectors() {
        const today = new Date();
        const yearSel = document.getElementById('inputYear');
        const monthSel = document.getElementById('inputMonth');
        const daySel = document.getElementById('inputDay');
        
        const statsYear = document.getElementById('statsYear');
        const statsMonth = document.getElementById('statsMonth');

        // ì—°ë„ ì„¸íŒ… (í˜„ì¬ ì—°ë„ ê¸°ì¤€ -2ë…„ ~ +8ë…„ -> 2034ë…„ê¹Œì§€)
        const currentYear = today.getFullYear();
        for (let y = currentYear - 2; y <= currentYear + 8; y++) {
            yearSel.add(new Option(y + 'ë…„', y));
            statsYear.add(new Option(y + 'ë…„', y));
        }
        yearSel.value = currentYear;
        statsYear.value = currentYear;

        // ì›” ì„¸íŒ…
        for (let m = 1; m <= 12; m++) {
            monthSel.add(new Option(m + 'ì›”', m));
            statsMonth.add(new Option(m + 'ì›”', m));
        }
        monthSel.value = today.getMonth() + 1;
        statsMonth.value = today.getMonth() + 1;

        // ì¼ ì„¸íŒ… í•¨ìˆ˜
        function updateDays() {
            const y = parseInt(yearSel.value);
            const m = parseInt(monthSel.value);
            const daysInMonth = new Date(y, m, 0).getDate();
            
            const currentDay = daySel.value;
            daySel.innerHTML = '';
            
            for (let d = 1; d <= daysInMonth; d++) {
                daySel.add(new Option(d + 'ì¼', d));
            }
            
            if (currentDay && currentDay <= daysInMonth) {
                daySel.value = currentDay;
            } else {
                daySel.value = Math.min(today.getDate(), daysInMonth);
            }
            updateDayOfWeek();
        }

        // ìš”ì¼ ìë™ ê³„ì‚° í•¨ìˆ˜
        function updateDayOfWeek() {
            const y = yearSel.value;
            const m = monthSel.value;
            const d = daySel.value;
            
            const date = new Date(y, m - 1, d);
            const days = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
            const dayOfWeek = days[date.getDay()];
            
            const display = document.getElementById('displayDayOfWeek');
            display.textContent = `${y}ë…„ ${m}ì›” ${d}ì¼ì€ [${dayOfWeek}] ì…ë‹ˆë‹¤.`;
            
            if (date.getDay() === 0) display.style.color = '#ef4444';
            else if (date.getDay() === 6) display.style.color = '#3b82f6';
            else display.style.color = 'inherit';
            
            return dayOfWeek;
        }

        yearSel.addEventListener('change', updateDays);
        monthSel.addEventListener('change', updateDays);
        daySel.addEventListener('change', updateDayOfWeek);

        updateDays();
        daySel.value = today.getDate();
        updateDayOfWeek();
    }

    // 2. ê¸°ë¡ ì¶”ê°€
    function addRecord() {
        const year = parseInt(document.getElementById('inputYear').value);
        const month = parseInt(document.getElementById('inputMonth').value);
        const day = parseInt(document.getElementById('inputDay').value);
        const count = document.getElementById('patientCount').value;
        const shift = document.querySelector('input[name="shift"]:checked').value;

        if (count === '') {
            alert('í™˜ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const dateObj = new Date(year, month - 1, day);
        const dayIdx = dateObj.getDay();

        const newRecord = {
            id: Date.now(),
            year: year,
            month: month,
            day: day,
            dayIdx: dayIdx,
            shift: shift,
            count: parseInt(count),
            timestamp: new Date().toISOString()
        };

        records.push(newRecord);
        saveData();
        
        document.getElementById('patientCount').value = '';
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        renderStats();
        renderHistory();
    }

    // 3. ë°ì´í„° ì €ì¥
    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    // 4. í†µê³„ ë Œë”ë§ (ì›”ë³„ + ì—°ê°„ í˜¸ì¶œ)
    function renderStats() {
        renderMonthlyStats();
        renderYearlyStats(); // ì—°ê°„ í†µê³„ë„ ê°™ì´ ê°±ì‹ 
    }

    // 4-1. ì›”ë³„ í†µê³„ ë¡œì§
    function renderMonthlyStats() {
        const targetYear = parseInt(document.getElementById('statsYear').value);
        const targetMonth = parseInt(document.getElementById('statsMonth').value);
        
        const tbody = document.querySelector('#statsTable tbody');
        tbody.innerHTML = '';

        const stats = Array.from({length: 7}, () => ({
            lSum: 0, lCnt: 0, dSum: 0, dCnt: 0
        }));

        records.forEach(r => {
            if (r.year === targetYear && r.month === targetMonth) {
                if (r.shift === 'lunch') {
                    stats[r.dayIdx].lSum += r.count;
                    stats[r.dayIdx].lCnt += 1;
                } else {
                    stats[r.dayIdx].dSum += r.count;
                    stats[r.dayIdx].dCnt += 1;
                }
            }
        });

        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const displayOrder = [1, 2, 3, 4, 5, 6, 0];

        displayOrder.forEach(dayIdx => {
            const s = stats[dayIdx];
            
            const lAvg = s.lCnt > 0 ? (s.lSum / s.lCnt).toFixed(1) : '-';
            const dAvg = s.dCnt > 0 ? (s.dSum / s.dCnt).toFixed(1) : '-';

            const tr = document.createElement('tr');
            
            let dayClass = '';
            if (dayIdx === 0) dayClass = 'day-sun';
            if (dayIdx === 6) dayClass = 'day-sat';

            tr.innerHTML = `
                <td class="${dayClass}" style="font-weight:bold;">${dayNames[dayIdx]}</td>
                <td class="bg-lunch">${s.lSum > 0 ? s.lSum : '-'}</td>
                <td class="bg-lunch" style="opacity:0.7;">${lAvg}</td>
                <td class="bg-dinner">${s.dSum > 0 ? s.dSum : '-'}</td>
                <td class="bg-dinner" style="opacity:0.7;">${dAvg}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 4-2. ì—°ê°„ í†µê³„ ë¡œì§ (ìš”ì¼ë³„ ì§‘ê³„ë¡œ ë³€ê²½)
    function renderYearlyStats() {
        const targetYear = parseInt(document.getElementById('statsYear').value);
        const tbody = document.querySelector('#yearlyStatsTable tbody');
        tbody.innerHTML = '';

        // ìš”ì¼ë³„ ì§‘ê³„ ì´ˆê¸°í™” (0:ì¼ ~ 6:í† )
        const stats = Array.from({length: 7}, () => ({
            lSum: 0, lCnt: 0, dSum: 0, dCnt: 0
        }));

        records.forEach(r => {
            if (r.year === targetYear) {
                // ì›”(month) êµ¬ë¶„ ì—†ì´, í•´ë‹¹ ì—°ë„ë©´ ìš”ì¼ë³„ë¡œ í•©ì‚°
                if (r.shift === 'lunch') {
                    stats[r.dayIdx].lSum += r.count;
                    stats[r.dayIdx].lCnt += 1;
                } else {
                    stats[r.dayIdx].dSum += r.count;
                    stats[r.dayIdx].dCnt += 1;
                }
            }
        });

        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const displayOrder = [1, 2, 3, 4, 5, 6, 0]; // ì›”~ì¼ ìˆœì„œ ì¶œë ¥

        displayOrder.forEach(dayIdx => {
            const s = stats[dayIdx];
            
            const lAvg = s.lCnt > 0 ? (s.lSum / s.lCnt).toFixed(1) : '-';
            const dAvg = s.dCnt > 0 ? (s.dSum / s.dCnt).toFixed(1) : '-';

            const tr = document.createElement('tr');
            
            let dayClass = '';
            if (dayIdx === 0) dayClass = 'day-sun';
            if (dayIdx === 6) dayClass = 'day-sat';

            tr.innerHTML = `
                <td class="${dayClass}" style="font-weight:bold;">${dayNames[dayIdx]}</td>
                <td class="bg-lunch">${s.lSum > 0 ? s.lSum : '-'}</td>
                <td class="bg-lunch" style="opacity:0.7;">${lAvg}</td>
                <td class="bg-dinner">${s.dSum > 0 ? s.dSum : '-'}</td>
                <td class="bg-dinner" style="opacity:0.7;">${dAvg}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 5. ê¸°ë¡ ë‚´ì—­ ë Œë”ë§
    function renderHistory() {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        const sortedRecords = [...records].sort((a, b) => b.id - a.id);
        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

        sortedRecords.forEach(r => {
            const tr = document.createElement('tr');
            const shiftName = r.shift === 'lunch' ? 'â˜€ï¸ ì ì‹¬' : 'ğŸŒ™ ì €ë…';
            
            if (r.shift === 'lunch') {
                tr.classList.add('bg-lunch');
            } else {
                tr.classList.add('bg-dinner');
            }
            
            tr.innerHTML = `
                <td>${r.month}/${r.day}</td>
                <td>${dayNames[r.dayIdx]}</td>
                <td>${shiftName}</td>
                <td style="font-weight:bold;">${r.count}ëª…</td>
                <td><button class="delete-btn" onclick="deleteRecord(${r.id})">ì‚­ì œ</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 6. ê¸°ë¡ ì‚­ì œ
    window.deleteRecord = function(id) {
        if(confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            records = records.filter(r => r.id !== id);
            saveData();
            renderStats();
            renderHistory();
        }
    };

</script>

</body>
</html>